<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SBA Home</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- PWA -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#fff3ff" />
    <link rel="stylesheet" href="css/layout.css" />
    <link rel="stylesheet" href="css/responsive.css" />
    <link rel="stylesheet" href="css/filters.css" />
    <link rel="stylesheet" href="css/cards.css" />

    <!-- Sync Button Styles (Added for PWA) -->
    <style>
      .header-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .sync-btn {
        background: white;
        color: #0b5c37;
        border: none;
        padding: 0.4rem 0.8rem;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.25s;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      .sync-btn:hover {
        background: #f0f0f0;
      }

      .sync-btn:disabled {
        background: #e2e8f0;
        color: #94a3b8;
        cursor: not-allowed;
      }

      .sync-status-bar {
        background: rgba(255, 255, 255, 0.95);
        padding: 0.75rem;
        border-radius: 8px;
        display: none;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }

      .sync-status-bar.active {
        display: flex;
      }

      .sync-progress {
        width: 100%;
        height: 8px;
        background: rgba(11, 92, 55, 0.2);
        border-radius: 4px;
        overflow: hidden;
      }

      .sync-progress-fill {
        height: 100%;
        background: #0b5c37;
        transition: width 0.3s ease;
      }

      .sync-status-text {
        font-size: 0.85rem;
        color: #0b5c37;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <main class="app-shell">
      <header class="app-header">
        <div class="header-top">
          <h1 class="header-title">Species Database</h1>
          <div class="header-actions">
            <button class="sync-btn" id="syncBtn" title="Sync data">ðŸ”„</button>
            <button class="lang-btn">EN</button>
          </div>
        </div>

        <!-- Sync Status Bar (Added for PWA) -->
        <div class="sync-status-bar" id="syncStatusBar">
          <div class="sync-progress">
            <div class="sync-progress-fill" id="syncProgressFill" style="width: 0%"></div>
          </div>
          <div class="sync-status-text" id="syncStatusText">Syncing...</div>
          <button class="lang-btn">EN</button>
        </div>

        <div class="search-bar">
          <span class="search-icon">
            <img src="Assets/icons/search.svg" alt="Search" />
          </span>

          <input type="text" placeholder="Search species" id="searchInput" />
        </div>
      </header>

      <!-- Filter Carousel -->
      <div class="filter-carousel-container">
        <div class="filter-carousel" id="filter-carousel">
          <button class="filter-button" data-filter="all">Reset</button>
          <button class="filter-button" data-filter="a-z">A-Z</button>
          <button class="filter-button" data-filter="leaf-type">
            Leaf Type
          </button>
          <button class="filter-button" data-filter="fruit-type">
            Fruit Type
          </button>
        </div>
      </div>

      <div class="container" id="species-list"></div>

      <a class="back-link" href="index.html"></a>

      <div class="debug" id="debugInfo"></div>

      <!-- LANGUAGE OVERLAY -->

      <div class="lang-overlay" id="langOverlay">
        <div
          class="lang-modal"
          role="dialog"
          aria-modal="true"
          aria-label="Choose language"
        >
          <button class="close-overlay" id="closeOverlay" aria-label="Close">
            âœ–
          </button>

          <div class="lang-title">You Selected</div>

          <div class="selected-pill" id="selectedPill">
            <div class="flag" id="selectedFlag" aria-hidden="true">ðŸ‡¦ðŸ‡º</div>
            <div class="selected-name" id="selectedName">ENGLISH AU</div>
            <div class="check-dot" aria-hidden="true">
              <svg viewBox="0 0 24 24">
                <path
                  d="M9.2 16.6 4.9 12.3l1.4-1.4 2.9 2.9 8-8 1.4 1.4-9.4 9.4z"
                />
              </svg>
            </div>
          </div>

          <div class="lang-title" style="margin-top: 18px">All Languages</div>

          <section class="card" aria-label="Language list">
            <div
              class="list"
              id="langList"
              role="listbox"
              aria-label="Languages"
            >
              <div
                class="row selected"
                role="option"
                aria-selected="true"
                data-code="EN"
                data-name="ENGLISH AU"
                data-flag="ðŸ‡¦ðŸ‡º"
              >
                <div class="flag" aria-hidden="true">ðŸ‡¦ðŸ‡º</div>
                <div class="name">ENGLISH AU</div>
                <div class="radio" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <path
                      d="M9.2 16.6 4.9 12.3l1.4-1.4 2.9 2.9 8-8 1.4 1.4-9.4 9.4z"
                    />
                  </svg>
                </div>
              </div>

              <div
                class="row"
                role="option"
                aria-selected="false"
                data-code="TET"
                data-name="Tetum"
                data-flag="ðŸ‡¹ðŸ‡±"
              >
                <div class="flag" aria-hidden="true">ðŸ‡¹ðŸ‡±</div>
                <div class="name">TETUM</div>
                <div class="radio" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <path
                      d="M9.2 16.6 4.9 12.3l1.4-1.4 2.9 2.9 8-8 1.4 1.4-9.4 9.4z"
                    />
                  </svg>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>

      <!-- FILTER OVERLAY -->
      <!-- FILTER OVERLAY (NEW) -->
      <div class="filter-overlay" id="filterOverlay">
        <div class="filter-modal">
          <button class="close-filter-overlay" id="closeFilterOverlay">
            âœ–
          </button>
          <h2 id="filterTitle"></h2>
          <p id="filterDescription"></p>
          <div id="filterOptions"></div>
        </div>
      </div>
    </main>

    <!-- Scripts (Original + PWA additions) -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> -->
    <script src="scripts/config.js"></script>
    <script src="scripts/db.js"></script>
    <script src="scripts/dataService.js"></script>
    <script src="scripts/sync.js"></script>
    <script src="scripts/bundleSync.js"></script>
    
    <script src="scripts/specieslist.js"></script>
    <script src="scripts/filterCarousel.js"></script>
    <script src="scripts/detectOnline.js" defer></script>
    <script src="scripts/sw-register.js" defer></script>

    <script>
      // ============================================
      // PAGE INITIALIZATION
      // ============================================
      document.addEventListener("DOMContentLoaded", async () => {
        console.log("[Home] Page loaded");

        const code = (document.querySelector(".lang-btn")?.textContent || "EN")
          .trim()
          .toLowerCase();
        const language = code === "tet" ? "tet" : "en";

        // Always do sync
        try {
          const syncResult = await syncManager.checkAndSync({ forceBundle: true });
          console.log("[Home] Sync result:", syncResult);
        } catch (err) {
          console.warn("[Home] Sync failed (offline mode). Using cached data:", err);
        }

        // Always load from IndexedDB (offline-safe)
        try {
          const species = await dataService.getAllSpecies(language);
          console.log("[Home] Loaded species:", species.length);
          window.setSpeciesData(species);
        } catch (err) {
          console.error("[Home] ERROR loading species from IndexedDB:", err);
        }
      });

      // ============================================
      // SYNC BUTTON HANDLER (Added for PWA)
      // ============================================
      const syncBtn = document.getElementById("syncBtn");
      const syncStatusBar = document.getElementById("syncStatusBar");
      const syncProgressFill = document.getElementById("syncProgressFill");
      const syncStatusText = document.getElementById("syncStatusText");

      let isSyncing = false;

      function updateSyncUI(data) {
        if (data.phase === "version") {
          syncStatusText.textContent = data.message;
        } else if (data.phase === "media") {
          const pct = (data.current / data.total) * 100;
          syncProgressFill.style.width = pct + "%";
          syncStatusText.textContent = data.message;
        } else if (data.phase === "done") {
          syncProgressFill.style.width = "100%";
          syncStatusText.textContent = "âœ… " + data.message;
          setTimeout(() => {
            syncStatusBar.classList.remove("active");
            location.reload();
          }, 1500);
        }
      }

      async function startManualSync() {
        if (isSyncing) return;
        isSyncing = true;
        syncBtn.disabled = true;
        syncStatusBar.classList.add("active");
        syncProgressFill.style.width = "0%";
        syncStatusText.textContent = "Starting sync...";

        try {
          if (typeof syncBundle === 'function') {
            await syncBundle({ onProgress: updateSyncUI });
          } else if (typeof syncManager !== 'undefined') {
            await syncManager.checkAndSync({ forceBundle: true });
            syncStatusText.textContent = "âœ… Sync complete!";
            setTimeout(() => {
              syncStatusBar.classList.remove("active");
              location.reload();
            }, 1500);
          }
        } catch (err) {
          console.error("[Sync] Error:", err);
          syncStatusText.textContent = "âŒ Error: " + err.message;
          setTimeout(() => syncStatusBar.classList.remove("active"), 3000);
        } finally {
          isSyncing = false;
          syncBtn.disabled = false;
        }
      }

      if (syncBtn) {
        syncBtn.addEventListener("click", startManualSync);
      }

      // ============================================
      // LANGUAGE HANDLER
      // ============================================

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
  console.log("[Home] Page loaded");

  const code = (document.querySelector(".lang-btn")?.textContent || "EN")
    .trim()
    .toLowerCase();
  const language = code === "tet" ? "tet" : "en";

  // Always do sync
  try {
    const syncResult = await syncManager.checkAndSync({ forceBundle: true });
    console.log("[Home] Sync result:", syncResult);
  } catch (err) {
    console.warn("[Home] Sync failed (offline mode). Using cached data:", err);
  }

  // Always load from IndexedDB (offline-safe)
  try {
    const species = await dataService.getAllSpecies(language);
    console.log("[Home] Loaded species:", species.length);
    window.setSpeciesData(species);
  } catch (err) {
    console.error("[Home] ERROR loading species from IndexedDB:", err);
  }
});

      // LANGUAGE HANDLER
      const langBtn = document.querySelector(".lang-btn");
      const overlay = document.getElementById("langOverlay");
      const closeBtn = document.getElementById("closeOverlay");
      const selectedNameEl = document.getElementById("selectedName");
      const selectedFlagEl = document.getElementById("selectedFlag");

      langBtn.addEventListener("click", () => {
        overlay.style.display = "flex";
      });
      closeBtn.addEventListener("click", () => {
        overlay.style.display = "none";
      });
      overlay.addEventListener("click", (e) => {
        if (e.target === overlay) overlay.style.display = "none";
      });

      document.querySelectorAll("#langList .row").forEach((row) => {
        row.addEventListener("click", () => {
          document.querySelectorAll("#langList .row").forEach((r) => {
            r.classList.remove("selected");
            r.setAttribute("aria-selected", "false");
          });
          row.classList.add("selected");
          row.setAttribute("aria-selected", "true");
          selectedNameEl.textContent = row.dataset.name;
          selectedFlagEl.textContent = row.dataset.flag;
          langBtn.textContent = row.dataset.code;
          overlay.style.display = "none";
          if (row.dataset.code === "TET") {
            window.location.href = "tetum.html";
          } else {
            window.location.href = "home.html";
          }
        });
      });

      // ============================================
      // FILTER OVERLAY
      // ============================================
      // ------------------------------
      // FILTER OVERLAY JS (NEW)
      // ------------------------------
      const filterOverlay = document.getElementById("filterOverlay");
      const closeFilterOverlay = document.getElementById("closeFilterOverlay");
      const filterTitle = document.getElementById("filterTitle");
      const filterOptions = document.getElementById("filterOptions");
      const filterDescription = document.getElementById("filterDescription");

      // Global state for active filters
      let activeFilters = {
        leafType: null,
        fruitType: null,
      };

      // Leaf Type options
      const leafTypeOptions = [
        "Simple",
        "Pinnately compound (single)",
        "Pinnately compound (double)",
        "Pinnately compound (triple)",
        "Palmately compound",
      ];

      // Fruit Type options
      const fruitTypeOptions = ["Drupe", "Capsule", "Follicle", "Pod"];

      const filterConfigs = {
        "a-z": {
          title: "Sort Alphabetically",
          description: "Sort species in ascending or descending order.",
          options: [
            { label: "A â†’ Z", action: () => sortSpecies("az") },
            { label: "Z â†’ A", action: () => sortSpecies("za") },
          ],
        },
        "leaf-type": {
          title: "Leaf Type",
          description: "",
          options: leafTypeOptions.map((option) => ({
            label: option,
            value: option,
            type: "leaf-type",
          })),
        },
        "fruit-type": {
          title: "Fruit Type",
          description: "",
          options: fruitTypeOptions.map((option) => ({
            label: option,
            value: option,
            type: "fruit-type",
          })),
        },
      };

      // Function to apply all active filters and search
      function applyFilters() {
        if (!loadedSpeciesData || loadedSpeciesData.length === 0) {
          console.warn("No species data loaded yet");
          return;
        }

        let filtered = [...loadedSpeciesData];

        // Apply leaf type filter
        if (activeFilters.leafType) {
          filtered = filtered.filter(
            (species) =>
              species.leaf_type && species.leaf_type === activeFilters.leafType
          );
        }

        // Apply fruit type filter
        if (activeFilters.fruitType) {
          filtered = filtered.filter(
            (species) =>
              species.fruit_type &&
              species.fruit_type === activeFilters.fruitType
          );
        }

        // Apply search filter
        const searchInput = document.getElementById("searchInput");
        if (searchInput && searchInput.value.trim() !== "") {
          const query = searchInput.value.toLowerCase().trim();
          filtered = filtered.filter(
            (species) =>
              species.scientific_name &&
              species.scientific_name.toLowerCase().includes(query)
          );
        }

        // Render results or show no results message
        if (filtered.length === 0 && typeof renderNoResults === 'function') {
          renderNoResults();
        } else {
          renderSpecies(filtered);
        }
      }

      window.applyFilters = applyFilters;

      function updateFilterButtonStates() {
        const leafTypeBtn = document.querySelector('[data-filter="leaf-type"]');
        const fruitTypeBtn = document.querySelector('[data-filter="fruit-type"]');

        if (leafTypeBtn) {
          leafTypeBtn.classList.toggle("active", !!activeFilters.leafType);
        }
        if (fruitTypeBtn) {
          fruitTypeBtn.classList.toggle("active", !!activeFilters.fruitType);
        }
      }

      // Make applyFilters available globally
      window.applyFilters = applyFilters;

      // Function to update filter button active states
      function updateFilterButtonStates() {
        const leafTypeBtn = document.querySelector('[data-filter="leaf-type"]');
        const fruitTypeBtn = document.querySelector(
          '[data-filter="fruit-type"]'
        );

        if (leafTypeBtn) {
          if (activeFilters.leafType) {
            leafTypeBtn.classList.add("active");
          } else {
            leafTypeBtn.classList.remove("active");
          }
        }

        if (fruitTypeBtn) {
          if (activeFilters.fruitType) {
            fruitTypeBtn.classList.add("active");
          } else {
            fruitTypeBtn.classList.remove("active");
          }
        }
      }

      // Function to create option buttons with active state
      function createOptionButton(option, filterType) {
        const optionBtn = document.createElement("button");
        optionBtn.className = "placeholder-option";
        const optionValue = option.value || option;
        optionBtn.textContent = option.label || option;

        const isActive =
          (filterType === "leaf-type" && activeFilters.leafType === optionValue) ||
          (filterType === "fruit-type" && activeFilters.fruitType === optionValue);
        // Check if this option is currently active
        const isActive =
          (filterType === "leaf-type" &&
            activeFilters.leafType === optionValue) ||
          (filterType === "fruit-type" &&
            activeFilters.fruitType === optionValue);

        if (isActive) {
          optionBtn.style.background = "#0f172a";
          optionBtn.style.color = "#ffffff";
        }

        optionBtn.onclick = () => {
          if (filterType === "leaf-type") {
            activeFilters.leafType = activeFilters.leafType === optionValue ? null : optionValue;
          } else if (filterType === "fruit-type") {
            activeFilters.fruitType = activeFilters.fruitType === optionValue ? null : optionValue;
          }

          updateFilterButtonStates();
          applyFilters();
            // Toggle leaf type filter
            if (activeFilters.leafType === optionValue) {
              activeFilters.leafType = null; // Deselect if already selected
            } else {
              activeFilters.leafType = optionValue; // Select new option
            }
          } else if (filterType === "fruit-type") {
            // Toggle fruit type filter
            if (activeFilters.fruitType === optionValue) {
              activeFilters.fruitType = null; // Deselect if already selected
            } else {
              activeFilters.fruitType = optionValue; // Select new option
            }
          }

          // Update filter button states
          updateFilterButtonStates();

          // Apply filters
          applyFilters();

          // Close overlay
          filterOverlay.style.display = "none";
        };

        return optionBtn;
      }

      document.querySelectorAll(".filter-button").forEach((btn) => {
        btn.addEventListener("click", () => {
          const key = btn.dataset.filter;

          if (key === "all") {
            activeFilters.leafType = null;
            activeFilters.fruitType = null;

            // Clear all filters
            activeFilters.leafType = null;
            activeFilters.fruitType = null;

            // Remove active state from all filter buttons except "all"
            document.querySelectorAll(".filter-button").forEach((b) => {
              if (b.dataset.filter !== "all") {
                b.classList.remove("active");
              }
            });
            btn.classList.add("active");

            // Reset search input
            const searchInput = document.getElementById("searchInput");
            if (searchInput) {
              searchInput.value = "";
            }

            if (loadedSpeciesData && loadedSpeciesData.length > 0) {
              renderSpecies(loadedSpeciesData);
            }
            return;
          }

          if (key === "a-z") {
            // Render all species - check if data is loaded
            if (loadedSpeciesData && loadedSpeciesData.length > 0) {
              renderSpecies(loadedSpeciesData);
            } else {
              console.warn("Species data not loaded yet");
            }
            
            // Don't show overlay for "All" button
            return;
          }

          // Don't remove active state for leaf-type and fruit-type buttons
          // They can be active simultaneously
          // A-Z is a sort, not a filter, so it can work alongside filters
          if (key === "a-z") {
            // A-Z can be active alongside leaf-type and fruit-type
            btn.classList.add("active");
          } else if (key !== "leaf-type" && key !== "fruit-type") {
            document.querySelectorAll(".filter-button").forEach((b) => {
              if (
                b.dataset.filter !== "leaf-type" &&
                b.dataset.filter !== "fruit-type" &&
                b.dataset.filter !== "a-z"
              ) {
                b.classList.remove("active");
              }
            });
            btn.classList.add("active");
          }

          const config = filterConfigs[key];
          if (!config) return;

          filterTitle.textContent = config.title;
          filterDescription.textContent = config.description;
          filterOptions.innerHTML = "";

          config.options.forEach((option) => {
            let optionBtn;

            if (option.action) {
              // For A-Z filter with actions
              optionBtn = document.createElement("button");
              optionBtn.className = "placeholder-option";
              optionBtn.textContent = option.label;
              optionBtn.onclick = () => {
                option.action();
                filterOverlay.style.display = "none";
              };
            } else {
                if (option.action) {
                  option.action();
                }
                filterOverlay.style.display = "none";
              };
            } else {
              // For leaf-type and fruit-type filters
              optionBtn = createOptionButton(option, key);
            }

            filterOptions.appendChild(optionBtn);
          });

          filterOverlay.style.display = "flex";
        });
      });

      closeFilterOverlay.addEventListener("click", () => {
        filterOverlay.style.display = "none";
      });

      // Initialize: Set "All" button as active by default when page loads
      document.addEventListener("DOMContentLoaded", () => {
        const allButton = document.querySelector('[data-filter="all"]');
        if (allButton) {
          allButton.classList.add("active");
        }
      });

      let originalOrder = null;

      document.addEventListener("DOMContentLoaded", () => {
        originalOrder = Array.from(document.querySelectorAll(".species-item"));
      });

      function resetSpeciesList() {
        const list = document.getElementById("species-list");
        if (!originalOrder) return;
        originalOrder.forEach((item) => list.appendChild(item));
      }

      function sortSpecies(direction) {
        if (!loadedSpeciesData || loadedSpeciesData.length === 0) {
          console.warn("No species data to sort.");
          return;
        }

        const sorted = [...loadedSpeciesData].sort((a, b) => {
          const nameA = a.scientific_name.toLowerCase();
          const nameB = b.scientific_name.toLowerCase();

          return direction === "az"
            ? nameA.localeCompare(nameB)
            : nameB.localeCompare(nameA);
        });

        renderSpecies(sorted);
      }
    </script>
  </body>
</html>
</html>